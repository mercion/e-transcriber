<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>e-transcriber demo</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 2rem;
      }
      button {
        margin-right: 1rem;
      }
      pre {
        background: #111827;
        color: #f9fafb;
        padding: 1rem;
        border-radius: 8px;
        max-height: 240px;
        overflow: auto;
      }
    </style>
  </head>
  <body>
    <h1>e-transcriber demo</h1>
    <p>Click start to send your microphone audio to the server.</p>
    <div>
      <button id="start">Start session</button>
      <button id="stop" disabled>Stop session</button>
    </div>
    <pre id="log"></pre>

    <script>
      const logEl = document.getElementById('log');
      const startBtn = document.getElementById('start');
      const stopBtn = document.getElementById('stop');

      let pc;
      let stream;

      function log(message) {
        logEl.textContent += `${message}\n`;
      }

      function waitForIceGatheringComplete(peerConnection) {
        if (peerConnection.iceGatheringState === 'complete') {
          return Promise.resolve();
        }
        return new Promise((resolve) => {
          const listener = () => {
            if (peerConnection.iceGatheringState === 'complete') {
              peerConnection.removeEventListener('icegatheringstatechange', listener);
              resolve();
            }
          };
          peerConnection.addEventListener('icegatheringstatechange', listener);
        });
      }

      async function startSession() {
        startBtn.disabled = true;
        stopBtn.disabled = false;

        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
        pc = new RTCPeerConnection({
          iceServers: [{ urls: 'stun:stun.l.google.com:19302' }],
        });

        stream.getTracks().forEach((track) => pc.addTrack(track, stream));

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await waitForIceGatheringComplete(pc);

        log('Sending SDP offer...');
        const response = await fetch('/session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sdp: pc.localDescription.sdp, type: pc.localDescription.type }),
        });

        if (!response.ok) {
          log(`Server error: ${response.status}`);
          return;
        }

        const data = await response.json();
        await pc.setRemoteDescription(new RTCSessionDescription(data));
        log('Session established. Speak into the mic and check server logs.');
      }

      async function stopSession() {
        stopBtn.disabled = true;
        startBtn.disabled = false;
        if (pc) {
          pc.getSenders().forEach((sender) => sender.track && sender.track.stop());
          pc.close();
          pc = null;
        }
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        log('Session stopped.');
      }

      startBtn.addEventListener('click', () => {
        startSession().catch((err) => {
          log(`Error: ${err.message}`);
          startBtn.disabled = false;
          stopBtn.disabled = true;
        });
      });
      stopBtn.addEventListener('click', () => {
        stopSession().catch((err) => log(`Error: ${err.message}`));
      });
    </script>
  </body>
</html>
